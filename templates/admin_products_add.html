<div class="content-header">
    <h2>‚ûï Agregar Producto</h2>
    <button onclick="window.location.reload()" class="btn-refresh">üîÑ Refrescar</button>
</div>

<div class="form-container">
    <form id="add-product-form" class="admin-form">
        <div class="form-group">
            <label for="nombre">Nombre:</label>
            <input type="text" id="nombre" name="nombre" required class="form-input">
        </div>

        <div class="form-group">
            <label for="descripcion">Descripci√≥n:</label>
            <textarea id="descripcion" name="descripcion" rows="3" class="form-input"></textarea>
        </div>

        <div class="form-group">
            <label for="precio">Precio:</label>
            <input type="number" id="precio" name="precio" step="0.01" min="0" required class="form-input">
        </div>

        <div class="form-group">
            <label for="stock">Stock:</label>
            <input type="number" id="stock" name="stock" min="0" required class="form-input">
        </div>

        <div class="form-group">
            <label for="id_categoria">Categor√≠a:</label>
            <select id="id_categoria" name="id_categoria" required class="form-input">
                <option value="">Seleccionar categor√≠a</option>
            </select>
        </div>

        <div class="form-group">
            <label for="imagen">URL de Imagen:</label>
            <input type="url" id="imagen" name="imagen" class="form-input">
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary">Guardar Producto</button>
            <button type="button" onclick="window.adminCloseModal()" class="btn-secondary">Cancelar</button>
        </div>
    </form>
</div>

<script>
    async function loadCategoriesForSelect() {
        try {
            const response = await fetch('/api/v1/categorias');
            const categories = await response.json();
            const select = document.getElementById('id_categoria');

            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id_categoria;
                option.textContent = `${cat.nombre} (ID: ${cat.id_categoria})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error cargando categor√≠as:', error);
        }
    }

    document.getElementById('add-product-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = {
            nombre: document.getElementById('nombre').value.trim(),
            descripcion: document.getElementById('descripcion').value.trim(),
            precio: parseFloat(document.getElementById('precio').value),
            stock: parseInt(document.getElementById('stock').value),
            id_categoria: parseInt(document.getElementById('id_categoria').value),
            imagen: document.getElementById('imagen').value.trim() || null
        };

        if (!formData.nombre) {
            alert('‚ùå El nombre es requerido');
            return;
        }

        if (formData.precio <= 0) {
            alert('‚ùå El precio debe ser mayor a 0');
            return;
        }

        if (formData.stock < 0) {
            alert('‚ùå El stock no puede ser negativo');
            return;
        }

        if (!formData.id_categoria) {
            alert('‚ùå Debes seleccionar una categor√≠a');
            return;
        }

        try {
            const response = await fetch('/api/v1/productos/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (response.ok) {
                alert(`‚úÖ Producto "${result.nombre}" agregado exitosamente (ID: ${result.id_producto})`);
                document.getElementById('add-product-form').reset();
            } else {
                alert(`‚ùå Error: ${result.detail || 'Error desconocido'}`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error de conexi√≥n con el servidor');
        }
    });

    loadCategoriesForSelect();
</script>