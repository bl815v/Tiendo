<div class="content-header">
    <h2>üìã Lista de Categor√≠as</h2>
    <button onclick="loadCategories()" class="btn-refresh">üîÑ Refrescar</button>
</div>

<div class="table-container">
    <table id="categories-table" class="admin-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Descripci√≥n</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="categories-body">
            <tr>
                <td colspan="4">Cargando categor√≠as...</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    async function loadCategories() {
        const tbody = document.getElementById('categories-body');
        tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';

        try {
            console.log('Haciendo fetch a /api/v1/categorias...');
            const response = await fetch('/api/v1/categorias', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });

            console.log('Respuesta recibida:', response.status, response.statusText);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const categories = await response.json();
            console.log('Datos recibidos:', categories);

            if (categories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">No hay categor√≠as registradas</td></tr>';
                return;
            }

            tbody.innerHTML = categories.map(cat => `
            <tr id="category-row-${cat.id_categoria}">
                <td>${cat.id_categoria}</td>
                <td><span class="editable" data-field="nombre">${cat.nombre}</span></td>
                <td><span class="editable" data-field="descripcion">${cat.descripcion || ''}</span></td>
                <td class="actions">
                    <button onclick="editCategory(${cat.id_categoria})" class="btn-edit">‚úèÔ∏è Editar</button>
                    <button onclick="saveCategory(${cat.id_categoria})" class="btn-save" style="display:none">üíæ Guardar</button>
                    <button onclick="deleteCategory(${cat.id_categoria})" class="btn-delete">üóëÔ∏è Eliminar</button>
                </td>
            </tr>
        `).join('');

            console.log('Tabla actualizada con', categories.length, 'categor√≠as');
        } catch (error) {
            console.error('Error cargando categor√≠as:', error);
            tbody.innerHTML = `
            <tr>
                <td colspan="4" style="color: red; text-align: center;">
                    Error cargando categor√≠as: ${error.message}<br>
                    Revisa la consola para m√°s detalles.
                </td>
            </tr>
        `;
        }
    }

    function editCategory(id) {
        const row = document.getElementById(`category-row-${id}`);
        const editBtn = row.querySelector('.btn-edit');
        const saveBtn = row.querySelector('.btn-save');

        row.querySelectorAll('.editable').forEach(span => {
            const field = span.dataset.field;
            const value = span.textContent;

            if (field === 'descripcion') {
                span.innerHTML = `<textarea class="edit-input" data-field="${field}" style="width:100%;min-height:60px">${value}</textarea>`;
            } else {
                span.innerHTML = `<input type="text" class="edit-input" data-field="${field}" value="${value}" style="width:100%">`;
            }
        });

        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-block';
    }

    async function saveCategory(id) {
        const row = document.getElementById(`category-row-${id}`);
        const inputs = row.querySelectorAll('.edit-input');
        const data = {};

        inputs.forEach(input => {
            data[input.dataset.field] = input.value;
        });

        try {
            console.log('Actualizando categor√≠a', id, 'con datos:', data);
            const response = await fetch(`/api/v1/categorias/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                alert('‚úÖ Categor√≠a actualizada');
                loadCategories();
            } else {
                alert(`‚ùå Error: ${result.detail || 'Error desconocido'}`);
            }
        } catch (error) {
            console.error('Error actualizando categor√≠a:', error);
            alert('‚ùå Error de conexi√≥n');
        }
    }

    async function deleteCategory(id) {
        if (!confirm('¬øEst√°s seguro de eliminar esta categor√≠a?')) return;

        try {
            console.log('Eliminando categor√≠a', id);
            const response = await fetch(`/api/v1/categorias/${id}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (response.ok) {
                alert('‚úÖ Categor√≠a eliminada');
                loadCategories();
            } else {
                alert(`‚ùå Error: ${result.detail || 'Error desconocido'}`);
            }
        } catch (error) {
            console.error('Error eliminando categor√≠a:', error);
            alert('‚ùå Error de conexi√≥n');
        }
    }
    loadCategories();
</script>